sudo: required
dist: trusty
language: ruby

before_install:
- gem install asciidoctor -v 1.5.2
- gem install tilt
- sudo pip install git+https://github.com/gitenberg-dev/gitberg
- sudo pip install git+https://github.com/gitenberg-dev/pg-epubmaker
script:
- VERSION=`ruby -e "require 'yaml'; meta = YAML.load_file('metadata.yaml'); puts meta['_version'];"`
- git clone https://github.com/gitenberg-dev/asciidoctor-htmlbook.git
- sudo pip install -r asciidoctor-htmlbook/gitberg-machine/requirements.txt

- /usr/bin/python -c "from gitenberg import travis; travis.build_epub()"
- ebook-convert book.epub book.mobi
- xvfb-run ebook-convert book.epub book.pdf
notifications:
  webhooks:
    urls:
      - https://unglue.it/api/travisci/webhook
    on_success: always
    on_failure: never
    on_start: never
deploy:
  skip_cleanup: true
  provider: releases
  api_key:
    secure: ZjAaDFqIG5+NGbmgdZp10gCJAXnMTJ6DH3a07ynS4mL4m3t6q1hEoRoFwg91ps0PgYddfcPUr1gPWdbUEVY1S2EgX6gM02B4niTVoI2h4lMv2OsDjxQ3AxQGnX/i0e50OCWLDFAs3d6tt6SoVTZBVOCEZVyep3jPAf4EfMoeHxW2xC1ggTskab0/XoVDtxAnskmrHEmJrAUVvB1sI4r3BM2hj08+12g/dblKoq7oThz+ChNVkXME9tuX4vbHvqb/O+FzcOU32MG1uTSe2QC9WfWg5nEkOPlD5PNWHICOS0W7Z4qdDY1aoB4780r1eSvoS0Vc810jO2gjwH2moCCvnmiUAIBR7atGYTZlF9kSHhDMpuKTDeOyujKbo3fkCj455KneCYwL/X2lDWp6XzWnMnrpXlGoIWNFTfYlH8G3KHvLXFkv6dwAdAE8n/mcDpD7MvzHvhP4zZinRmlFDradpJ/3qChPpFjKne0fBLvurcamM6RoQOkhyYxkURhPqz77PKuYU+usjVurX2OuR8Su/0KeKHt/vrpBZaHF9M296Dp8BV433N1Pqv4Awmul3AlWIt96rzXqHwS+ZuPZLGknVxINrvv28EZN1P/KBCEukoIaeSPq3aiSSWN2t2TC38XHWbKeRfnQpu0vNWVE5snigW8xE6y9aSWWY/B7xygKfwU=
  file:
    - book.epub
    - book.mobi
    - book.pdf
  on:
    repo: GITenberg/Othello_2267
    tags: true
addons:
  apt:
    packages:
    - xsltproc
    - xvfb
    - calibre
    - python-pip
    - git
    - python-dev
    - libjpeg-dev
    - libpng-dev
    - libfreetype6
    - libfreetype6-dev
    - zlib1g-dev
    - python-lxml
    - libxml2-dev
    - libxslt1-dev
    - tidy